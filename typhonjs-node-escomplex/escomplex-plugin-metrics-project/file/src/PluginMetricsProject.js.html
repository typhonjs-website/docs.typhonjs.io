<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/PluginMetricsProject.js | escomplex-plugin-metrics-project API Document</title>
  <link type="text/css" rel="stylesheet" href="css/mdl/material.min.css">
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/mdl/material.override.css">
  <link type="text/css" rel="stylesheet" href="css/navigation/nav-accordion-style.css">
  <link type="text/css" rel="stylesheet" href="css/navigation/esdoc-nav-style.css">
  <link type="text/css" rel="stylesheet" href="css/scrollbar/webkit-style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">
<div id="contextpopup">
   <button id="context-menu" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-js-ripple-effect hidden">
      <i class="material-icons">more_vert</i>
   </button>

   <ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="context-menu">
      <li class="mdl-menu__item hidden" data-action="openLink">Open on ...</li>
      <li class="mdl-menu__item hidden" data-action="openLink">Open on ...</li>
      <li disabled class="mdl-menu__item hidden">Version: ...</li>
   </ul>
</div>


<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/typhonjs-node-escomplex/escomplex-plugin-metrics-project.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><ul class="nav-accordion-menu animated hidden" data-nav-id="docs-nav-id-1465807525139" data-ice="navData">
<li data-ice="navGroup" class="has-children"><input type="checkbox" name="group-0" id="group-0" checked><label for="group-0" class="nav-header">Local Source</label>
   <ul>
      
   <li data-ice="navFolder" class="has-children"><input type="checkbox" name="folder-0" id="folder-0" checked><label for="folder-0" class="nav-dir-path" data-scm-link="https://github.com/typhonjs-node-escomplex/escomplex-plugin-metrics-project/tree/master/src" data-scm-type="github">src</label>
         <ul>
            
         <li data-ice="navFile" class="has-children nav-accordion-file"><input type="checkbox" name="file-0" id="file-0" checked><label for="file-0" class="nav-file hidden" data-scm-link="https://github.com/typhonjs-node-escomplex/escomplex-plugin-metrics-project/tree/master/src/PluginMetricsProject.js" data-scm-type="github">PluginMetricsProject.js</label>
               <ul>
                  
               <li data-ice="doc" class="nav-kind-class"><span data-ice="docLink"><a href="class/src/PluginMetricsProject.js~PluginMetricsProject.html" data-scm-link="https://github.com/typhonjs-node-escomplex/escomplex-plugin-metrics-project/tree/master/src/PluginMetricsProject.js#L8" data-scm-type="github">PluginMetricsProject</a></span></li>
</ul>
            </li>
</ul>
      </li>
</ul>
</li>
</ul></nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/PluginMetricsProject.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import path from &apos;path&apos;;

/**
 * Provides default project metrics gathering and calculation.
 */
export default class PluginMetricsProject
{
   // ESComplexProject plugin callbacks -----------------------------------------------------------------------------

   /**
    * Loads any default settings that are not already provided by any user options.
    *
    * @param {object}   ev - escomplex plugin event data.
    *
    * The following options are:
    * ```
    * (boolean)   newmi - Boolean indicating whether the maintainability index should be rebased on a scale from
    *                     0 to 100; defaults to false.
    * ```
    */
   onConfigure(ev)
   {
      ev.data.settings.noCoreSize = typeof ev.data.options.noCoreSize === &apos;boolean&apos; ?
       ev.data.options.noCoreSize : false;
   }

   onProjectEnd(ev)
   {
      this.createAdjacencyMatrix(ev.data.results);
      if (!this.settings.noCoreSize)
      {
         this.createVisibilityMatrix(ev.data.results);
         this.setCoreSize(ev.data.results);
      }

      this.calculateAverages(ev.data.results);
   }

   onProjectStart(ev)
   {
      this.settings = ev.data.settings;
   }

   // Project metrics calculation -----------------------------------------------------------------------------------

   adjacencyToDistMatrix(matrix)
   {
      const distMatrix = [];
      let i, j, value;
      for (i = 0; i &lt; matrix.length; i += 1)
      {
         distMatrix.push([]);
         for (j = 0; j &lt; matrix[i].length; j += 1)
         {
            value = null;
            if (i === j)
            {
               value = 1;
            }
            else
            {
               // where we have 0, set distance to Infinity
               value = matrix[i][j] || Infinity;
            }
            distMatrix[i][j] = value;
         }
      }
      return distMatrix;
   }

   calculateAverages(result)
   {
      let divisor;

      const sums = {
         loc: 0,
         cyclomatic: 0,
         effort: 0,
         params: 0,
         maintainability: 0
      };

      if (result.reports.length === 0) { divisor = 1; }
      else { divisor = result.reports.length; }

      result.reports.forEach((report) =&gt;
      {
         Object.keys(sums).forEach((key) =&gt; { sums[key] += report[key]; });
      });

      Object.keys(sums).forEach((key) =&gt;
      {
         result[key] = sums[key] / divisor;
      });
   }

   checkDependency(from, dependency, to)
   {
      if (this.isCommonJSDependency(dependency))
      {
         if (this.isInternalCommonJSDependency(dependency)) { return this.isDependency(from, dependency, to); }

         return false;
      }

      return this.isDependency(from, dependency, to);
   }

   compareNumbers(lhs, rhs)
   {
      if (lhs &lt; rhs) { return -1; }
      if (lhs &gt; rhs) { return 1; }
      return 0;
   }

   comparePaths(lhs, rhs)
   {
      const lsplit = lhs.split(path.sep);
      const rsplit = rhs.split(path.sep);

      if (lsplit.length &lt; rsplit.length || (lsplit.length === rsplit.length &amp;&amp; lhs &lt; rhs)) { return -1; }

      if (lsplit.length &gt; rsplit.length || (lsplit.length === rsplit.length &amp;&amp; lhs &gt; rhs)) { return 1; }

      return 0;
   }

   createAdjacencyMatrix(result)
   {
      const adjacencyMatrix = new Array(result.reports.length);
      let density = 0;

      result.reports.sort((lhs, rhs) =&gt; { return this.comparePaths(lhs.path, rhs.path); }).forEach((ignore, x) =&gt;
      {
         adjacencyMatrix[x] = new Array(result.reports.length);
         result.reports.forEach((ignore, y) =&gt;
         {
            adjacencyMatrix[x][y] = this.getAdjacencyMatrixValue(result.reports, x, y);
            if (adjacencyMatrix[x][y] === 1)
            {
               density += 1;
            }
         });
      });

      result.adjacencyMatrix = adjacencyMatrix;
      result.firstOrderDensity = this.percentifyDensity(density, adjacencyMatrix);
   }


   /**
    * Implementation of Floyd Warshall algorithm for calculating visibility matrix in O(n^3) instead of O(n^4) with
    * successive raising of powers.
    *
    * @param {object}   results - The ESComplexProject results data.
    */
   createVisibilityMatrix(results)
   {
      let changeCost = 0, i, j, k, visibilityMatrix;

      visibilityMatrix = this.adjacencyToDistMatrix(results.adjacencyMatrix);
      const matrixLen = visibilityMatrix.length;

      for (k = 0; k &lt; matrixLen; k += 1)
      {
         for (i = 0; i &lt; matrixLen; i += 1)
         {
            for (j = 0; j &lt; matrixLen; j += 1)
            {
               if (visibilityMatrix[i][j] &gt; visibilityMatrix[i][k] + visibilityMatrix[k][j])
               {
                  visibilityMatrix[i][j] = visibilityMatrix[i][k] + visibilityMatrix[k][j];
               }
            }
         }
      }

      // convert back from a distance matrix to adjacency matrix, while also calculating change cost
      visibilityMatrix = visibilityMatrix.map((row, rowIndex) =&gt;
      {
         return row.map((value, columnIndex) =&gt;
         {
            if (value &lt; Infinity)
            {
               changeCost += 1;

               if (columnIndex !== rowIndex)
               {
                  return 1;
               }
            }

            return 0;
         });
      });

      results.visibilityMatrix = visibilityMatrix;
      results.changeCost = this.percentifyDensity(changeCost, visibilityMatrix);
   }

   doesDependencyExist(from, to)
   {
      return from.dependencies.reduce((result, dependency) =&gt;
      {
         if (result === false) { return this.checkDependency(from.path, dependency, to.path); }

         return true;
      }, false);
   }

   getAdjacencyMatrixValue(reports, x, y)
   {
      if (x === y) { return 0; }

      if (this.doesDependencyExist(reports[x], reports[y])) { return 1; }

      return 0;
   }

   getMedian(values)
   {
      values.sort(this.compareNumbers);

      // Checks of values.length is odd.
      if (values.length % 2)
      {
         return values[(values.length - 1) / 2];
      }

      return (values[(values.length - 2) / 2] + values[values.length / 2]) / 2;
   }

   isCommonJSDependency(dependency)
   {
      return dependency.type === &apos;cjs&apos;;
   }

   isDependency(from, dependency, to)
   {
      let dependencyPath = dependency.path;

      if (path.extname(dependencyPath) === &apos;&apos;) { dependencyPath += path.extname(to); }

      return path.resolve(path.dirname(from), dependencyPath) === to;
   }

   isInternalCommonJSDependency(dependency)
   {
      return dependency.path[0] === &apos;.&apos; &amp;&amp;
       (dependency.path[1] === path.sep || (dependency.path[1] === &apos;.&apos; &amp;&amp; dependency.path[2] === path.sep));
   }

   percentify(value, limit)
   {
      if (limit === 0) { return 0; }

      return (value / limit) * 100;
   }

   percentifyDensity(density, matrix)
   {
      return this.percentify(density, matrix.length * matrix.length);
   }

   setCoreSize(result)
   {
      if (result.firstOrderDensity === 0)
      {
         result.coreSize = 0;
         return;
      }

      const fanIn = new Array(result.visibilityMatrix.length);
      const fanOut = new Array(result.visibilityMatrix.length);
      const boundaries = {};
      let coreSize = 0;

      result.visibilityMatrix.forEach((row, rowIndex) =&gt;
      {
         fanIn[rowIndex] = row.reduce((sum, value, valueIndex) =&gt;
         {
            if (rowIndex === 0)
            {
               fanOut[valueIndex] = value;
            }
            else
            {
               fanOut[valueIndex] += value;
            }

            return sum + value;
         }, 0);
      });

      // Boundary values can also be chosen by looking for discontinuity in the
      // distribution of values, but I&apos;ve chosen the median to keep it simple.
      boundaries.fanIn = this.getMedian(fanIn.slice());
      boundaries.fanOut = this.getMedian(fanOut.slice());

      result.visibilityMatrix.forEach((ignore, index) =&gt;
      {
         if (fanIn[index] &gt;= boundaries.fanIn &amp;&amp; fanOut[index] &gt;= boundaries.fanOut)
         {
            coreSize += 1;
         }
      });

      result.coreSize = this.percentify(coreSize, result.visibilityMatrix.length);
   }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.0-alpha)</span></a>
</footer>

<script src="script/jquery/jquery.min.js"></script>
<script src="script/navigation/enhancednav.js"></script>
<script defer src="script/mdl/material.min.js"></script>
<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
